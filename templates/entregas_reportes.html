{% extends "base_entregas.html" %}

{% block title %}Reportes de Entregas - Sistema de Administración{% endblock %}

{% block content %}
<div class="card">
    <h2><i class="fas fa-chart-bar"></i> Reportes de Entregas</h2>
    
    <div class="alert alert-success" id="successAlert">
        <i class="fas fa-check-circle"></i> 
        <strong>¡Éxito!</strong> <span id="successMessage"></span>
    </div>
    
    <div class="alert alert-error" id="errorAlert">
        <i class="fas fa-exclamation-circle"></i> 
        <strong>Error:</strong> <span id="errorMessage"></span>
    </div>
    
    <!-- Sección de carga de archivos -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px;">
        <!-- Archivo Ventas Convencionales y Especiales -->
        <div style="background: #fff5f5; padding: 20px; border-radius: 10px; border: 2px solid #feb2b2;">
            <h3 style="color: #C8102E; margin: 0 0 10px 0;">
                <i class="fas fa-file-csv"></i> Ventas Convencionales y Especiales
            </h3>
            <p style="color: #4a5568; margin-bottom: 15px; font-size: 0.85em;">
                Archivo Excel con entregas YAC (Convencionales) y F01/F02 (Especiales)
            </p>
            <div class="drop-zone" id="dropZoneConvencional" style="border-color: #EB0A1E; padding: 15px;">
                <i class="fas fa-file-excel" style="color: #EB0A1E; font-size: 1.5em;"></i>
                <p style="color: #2D2D2D; font-weight: 600; margin: 8px 0 3px 0; font-size: 0.9em;">Arrastra el archivo Excel aquí</p>
                <p class="hint" style="font-size: 0.8em;">o haz clic para seleccionar</p>
                <input type="file" id="fileConvencional" accept=".xlsx,.xls" style="display: none;">
            </div>
            <div id="convencionalStatus" style="display: none; margin-top: 12px; padding: 10px; background: white; border-radius: 6px; border-left: 4px solid #EB0A1E;">
                <i class="fas fa-check-circle" style="color: #EB0A1E;"></i>
                <span id="convencionalFileName" style="font-weight: 600; margin-left: 8px;"></span>
                <p style="margin: 6px 0 0 0; font-size: 0.8em; color: #718096;" id="convencionalInfo"></p>
            </div>
        </div>
        
        <!-- Archivo Plan de Ahorro -->
        <div style="background: #f7fafc; padding: 20px; border-radius: 10px; border: 2px solid #e2e8f0;">
            <h3 style="color: #2D2D2D; margin: 0 0 10px 0;">
                <i class="fas fa-file-csv"></i> Plan de Ahorro
            </h3>
            <p style="color: #4a5568; margin-bottom: 15px; font-size: 0.85em;">
                Archivo Excel con entregas TPA (Plan de Ahorro)
            </p>
            <div class="drop-zone" id="dropZonePlanAhorro" style="padding: 15px;">
                <i class="fas fa-file-excel" style="font-size: 1.5em;"></i>
                <p style="color: #2D2D2D; font-weight: 600; margin: 8px 0 3px 0; font-size: 0.9em;">Arrastra el archivo Excel aquí</p>
                <p class="hint" style="font-size: 0.8em;">o haz clic para seleccionar</p>
                <input type="file" id="filePlanAhorro" accept=".xlsx,.xls" style="display: none;">
            </div>
            <div id="planAhorroStatus" style="display: none; margin-top: 12px; padding: 10px; background: white; border-radius: 6px; border-left: 4px solid #58595B;">
                <i class="fas fa-check-circle" style="color: #58595B;"></i>
                <span id="planAhorroFileName" style="font-weight: 600; margin-left: 8px;"></span>
                <p style="margin: 6px 0 0 0; font-size: 0.8em; color: #718096;" id="planAhorroInfo"></p>
            </div>
        </div>
    </div>
    
    <!-- Botones de acción -->
    <div style="margin-top: 30px; text-align: center;">
        <button id="btnProcesar" class="btn btn-primary" onclick="procesarArchivos()" disabled>
            <i class="fas fa-cogs"></i> Procesar Archivos
        </button>
        <button id="btnLimpiar" class="btn btn-secondary" onclick="limpiarTodo()">
            <i class="fas fa-trash-alt"></i> Limpiar Todo
        </button>
    </div>
    
    <div class="spinner" id="loadingSpinner"></div>
    
    <!-- Dashboard de resultados -->
    <div id="dashboardSection" style="display: none; margin-top: 40px;">
        <!-- Filtros de fecha -->
        <div style="background: #f7fafc; padding: 20px; border-radius: 10px; margin-bottom: 30px;">
            <h3 style="color: #2D2D2D; margin-bottom: 15px;">
                <i class="fas fa-filter"></i> Filtros de Análisis
            </h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; align-items: end;">
                <div>
                    <label style="display: block; margin-bottom: 8px; color: #4a5568; font-weight: 600;">
                        <i class="fas fa-calendar-alt"></i> Fecha Desde:
                    </label>
                    <input type="date" id="fechaDesde" onchange="aplicarFiltros()" 
                           style="width: 100%; padding: 10px; border: 2px solid #cbd5e0; border-radius: 6px;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 8px; color: #4a5568; font-weight: 600;">
                        <i class="fas fa-calendar-alt"></i> Fecha Hasta:
                    </label>
                    <input type="date" id="fechaHasta" onchange="aplicarFiltros()" 
                           style="width: 100%; padding: 10px; border: 2px solid #cbd5e0; border-radius: 6px;">
                </div>
                <div>
                    <button onclick="aplicarFiltros()" class="btn btn-primary" style="width: 100%;">
                        <i class="fas fa-search"></i> Aplicar Filtros
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Resumen general -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <div class="stat-card" style="background: linear-gradient(135deg, #E84C3D, #C8102E);">
                <div class="stat-value" id="totalRemitos">0</div>
                <div class="stat-label">Total Remitos</div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #C8102E, #A0252A);">
                <div class="stat-value" id="totalConvencionales">0</div>
                <div class="stat-label">Ventas Convencionales</div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #A0252A, #7A1E23);">
                <div class="stat-value" id="totalPlanAhorro">0</div>
                <div class="stat-label">Plan de Ahorro</div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #7A1E23, #5C1619);">
                <div class="stat-value" id="totalEspeciales">0</div>
                <div class="stat-label">Ventas Especiales</div>
            </div>
        </div>
        
        <!-- Gráfico mensual -->
        <div style="background: white; padding: 25px; border-radius: 10px; border: 2px solid #e2e8f0; margin-bottom: 30px;">
            <h3 style="color: #2D2D2D; margin-bottom: 20px;">
                <i class="fas fa-chart-line"></i> Entregas Mensuales por Tipo
            </h3>
            <canvas id="chartMensual" style="max-height: 400px;"></canvas>
        </div>
        
        <!-- Desglose por sucursal -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <!-- Casa Central -->
            <div style="background: white; padding: 25px; border-radius: 10px; border: 2px solid #e2e8f0;">
                <h4 style="color: #2D2D2D; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-building" style="color: #EB0A1E;"></i> Casa Central
                </h4>
                <div id="statsCasaCentral"></div>
            </div>
            
            <!-- San Rafael -->
            <div style="background: white; padding: 25px; border-radius: 10px; border: 2px solid #e2e8f0;">
                <h4 style="color: #2D2D2D; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-building" style="color: #6B6B6B;"></i> San Rafael
                </h4>
                <div id="statsSanRafael"></div>
            </div>
            
            <!-- Bombal -->
            <div style="background: white; padding: 25px; border-radius: 10px; border: 2px solid #e2e8f0;">
                <h4 style="color: #2D2D2D; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-building" style="color: #2D2D2D;"></i> Bombal
                </h4>
                <div id="statsBombal"></div>
            </div>
        </div>
        
        <!-- Panel de diagnóstico -->
        <div id="diagnosticoPanel" style="display: none; background: #fff5f5; padding: 25px; border-radius: 10px; border: 2px solid #feb2b2; margin-bottom: 30px;">
            <h3 style="color: #C8102E; margin-bottom: 15px;">
                <i class="fas fa-exclamation-triangle"></i> Diagnóstico: Remitos Sin Clasificar
            </h3>
            <p style="color: #4a5568; margin-bottom: 15px;">
                Se encontraron <strong id="cantidadSinClasificar" style="color: #EB0A1E;">0</strong> remitos que no pudieron ser asignados a ninguna sucursal.
            </p>
            <div style="background: white; padding: 15px; border-radius: 8px; max-height: 300px; overflow-y: auto;">
                <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                    <thead>
                        <tr style="background: #f7fafc; border-bottom: 2px solid #e2e8f0;">
                            <th style="padding: 10px; text-align: left; color: #2D2D2D;">Nro. Remito</th>
                            <th style="padding: 10px; text-align: left; color: #2D2D2D;">Código</th>
                            <th style="padding: 10px; text-align: left; color: #2D2D2D;">Tipo Venta</th>
                            <th style="padding: 10px; text-align: left; color: #2D2D2D;">Nro. Fábrica</th>
                            <th style="padding: 10px; text-align: left; color: #2D2D2D;">Fecha</th>
                        </tr>
                    </thead>
                    <tbody id="tablaSinClasificar"></tbody>
                </table>
            </div>
        </div>
        
        <!-- Botón exportar -->
        <div style="text-align: center; margin-top: 30px;">
            <button onclick="exportarReporte()" class="btn btn-success">
                <i class="fas fa-file-excel"></i> Exportar Reporte a Excel
            </button>
        </div>
    </div>
</div>

<style>
.stat-card {
    padding: 20px;
    border-radius: 10px;
    color: white;
    text-align: center;
}

.stat-value {
    font-size: 2.8em;
    font-weight: 700;
    margin-bottom: 8px;
}

.stat-label {
    font-size: 0.9em;
    opacity: 0.95;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 500;
}
</style>

<!-- Librería Chart.js para gráficos -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<!-- Librería SheetJS para exportar a Excel -->
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

<script src="{{ url_for('static', filename='js/entregas_reportes.js') }}"></script>
{% endblock %}
